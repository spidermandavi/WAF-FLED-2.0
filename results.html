<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>WAF-FLED! Tournaments</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="style.css">

<style>
.tournament-list {
  display: flex;
  flex-wrap: wrap;
  gap: 1rem;
  margin-top: 1rem;
}
.tournament-box {
  background: #1f2430;
  border-radius: 10px;
  padding: 1rem;
  flex: 1 1 250px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.3);
  display: flex;
  flex-direction: column;
  justify-content: space-between;
  transition: transform 0.2s;
}
.tournament-box:hover { transform: scale(1.03); }

.tournament-status { font-weight: bold; margin-top: 0.5rem; }
.status-past { color: #4caf50; }
.status-future { color: #ffd54a; }

.loading {
  text-align: center;
  opacity: 0.8;
  font-style: italic;
  margin-top: 1rem;
}

#lastUpdated {
  display: block;
  margin-bottom: 1rem;
  font-size: 0.85rem;
  color: #aaa;
}
</style>
</head>

<body>
<header>
<h1>ðŸ§‡ WAF-FLED!</h1>
<nav>
<a href="index.html">Leaderboard</a>
<a href="results.html">Tournaments</a>
<a href="achievements.html">Achievements</a>
</nav>
</header>

<main>
<small id="lastUpdated">Last updated on: --</small>

<h2>Tournaments</h2>
<div id="tournamentContainer" class="tournament-list">
<p class="loading">Loading tournaments...</p>
</div>
</main>

<script>
// ================= CONFIG =================
const TEAM_SLUG = "world-antichess-front";
const NAME_REGEX = /^Weekly WAF-FLED \d+ Arena$/;

// ================= FETCH TEAM TOURNAMENTS (FIXED) =================
async function fetchTeamTournaments(){
  try {
    const res = await fetch(`https://lichess.org/api/team/${TEAM_SLUG}/tournaments`);
    const text = await res.text();

    let tournaments = [];
    try {
      const jsonArray = JSON.parse(text);
      if (Array.isArray(jsonArray)) tournaments = jsonArray;
    } catch {
      tournaments = text
        .trim()
        .split("\n")
        .map(line => JSON.parse(line));
    }

    return tournaments.filter(t => NAME_REGEX.test(t.name));
  } catch {
    return [];
  }
}

// ================= RENDER =================
function renderTournaments(tournaments){
  const container = document.getElementById("tournamentContainer");

  if(!tournaments.length){
    container.innerHTML = "<p class='loading'>No tournaments found</p>";
    return;
  }

  tournaments.sort((a,b)=>b.startsAt - a.startsAt);

  container.innerHTML = tournaments.map(t=>{
    const endTime = new Date(t.finishesAt || t.endsAt || t.startsAt);
    const isPast = t.status === "finished" || endTime < new Date();
    const statusClass = isPast ? "status-past" : "status-future";
    const statusText = isPast ? "Finished" : "Upcoming";

    return `
      <div class="tournament-box">
        <a href="https://lichess.org/tournament/${t.id}" target="_blank">${t.name}</a>
        <span class="tournament-status ${statusClass}">${statusText}</span>
        <span>${isPast ? "Ended" : "Starts"}: ${new Date(t.startsAt).toLocaleString()}</span>
      </div>
    `;
  }).join("");
}

// ================= BUILD =================
async function buildTournaments(){
  document.getElementById("tournamentContainer").innerHTML =
    '<p class="loading">Loading tournaments...</p>';

  const tournaments = await fetchTeamTournaments();

  renderTournaments(tournaments);
  document.getElementById("lastUpdated").innerText =
    "Last updated on: " + new Date().toLocaleString();
}

// AUTO LOAD
buildTournaments();
</script>
</body>
</html>
