<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>WAF-FLED! Tournaments</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="style.css">
</head>
<body>
<header>
  <h1>üßá WAF-FLED!</h1>
  <nav>
    <a href="index.html">Leaderboard</a>
    <a href="results.html">Tournaments</a>
    <a href="achievements.html">Achievements</a>
  </nav>
</header>

<main>
  <div class="update-section">
    <button class="update-btn" id="updateBtn">üîÑ Check for new tournaments</button>
    <small id="updateNote">‚ö†Ô∏è Press only when needed. Frequent clicks may take a few seconds.</small>
  </div>
  <small id="lastUpdated">Last updated on: --</small>

  <h2>üìÖ Tournament History & Upcoming</h2>
  <ul id="tournamentList">
    <li class="loading"><div class="spinner"></div> Loading tournaments...</li>
  </ul>
</main>

<script>
const TOURNAMENTS = [
  { id: "ZLfbxNcu", name: "Weekly WAF-FLED #1 Arena" },
  { id: "Z2DuzTxs", name: "Weekly WAF-FLED 2 Arena" }
];

let cachedData = JSON.parse(localStorage.getItem("wafData")) || { tournaments: [], lastUpdated: null };

function renderTournaments() {
  const listEl = document.getElementById("tournamentList");
  if(!cachedData.tournaments.length){
    listEl.innerHTML='<li class="loading">No tournaments yet</li>';
    return;
  }

  listEl.innerHTML = cachedData.tournaments.map(t => `
    <li>
      <a href="https://lichess.org/tournament/${t.id}" target="_blank">
        ${t.name} ${t.isFinished ? "(Finished)" : "(Upcoming)"}
      </a>
    </li>
  `).join("");

  const lastUpdated = cachedData.lastUpdated ? new Date(cachedData.lastUpdated).toLocaleString() : "--";
  document.getElementById("lastUpdated").innerText = `Last updated on: ${lastUpdated}`;
}

async function fetchTournamentStatus(t) {
  try {
    const r = await fetch(`https://lichess.org/api/tournament/${t.id}`);
    const data = await r.json();
    return { ...t, isFinished: data.status==="finished" };
  } catch {
    return { ...t, isFinished: true }; // fallback
  }
}

async function updateTournaments() {
  document.getElementById("updateBtn").disabled=true;
  document.getElementById("updateBtn").innerText="Loading...";
  const updatedTournaments = [];

  for(const t of TOURNAMENTS){
    const tStatus = await fetchTournamentStatus(t);
    updatedTournaments.push(tStatus);
  }

  cachedData.tournaments = updatedTournaments;
  cachedData.lastUpdated = Date.now();
  localStorage.setItem("wafData", JSON.stringify(cachedData));

  renderTournaments();
  document.getElementById("updateBtn").disabled=false;
  document.getElementById("updateBtn").innerText="üîÑ Check for new tournaments";
}

document.getElementById("updateBtn").addEventListener("click", updateTournaments);

renderTournaments();
</script>
</body>
</html>
