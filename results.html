<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>WAF-FLED! Tournaments</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="style.css">

  <style>
    .tournament-list { display: flex; flex-wrap: wrap; gap: 1rem; margin-top: 1rem; }
    .tournament-box {
      background: #1f2430;
      border-radius: 10px;
      padding: 1rem;
      flex: 1 1 250px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      transition: transform 0.2s;
    }
    .tournament-box:hover { transform: scale(1.03); }
    .tournament-status { font-weight: bold; margin-top: 0.5rem; }
    .status-past { color: #4caf50; }
    .status-future { color: #ffd54a; }
    .loading { text-align: center; opacity: 0.8; font-style: italic; margin-top: 1rem; }
  </style>
</head>
<body>
<header>
  <h1>ðŸ§‡ WAF-FLED!</h1>
  <nav>
    <a href="index.html">Leaderboard</a>
    <a href="results.html">Tournaments</a>
    <a href="achievements.html">Achievements</a>
  </nav>
</header>

<main>
  <div class="update-section">
    <button class="update-btn" id="updateBtn">ðŸ”„ Check for new tournaments</button>
    <small id="updateNote">
      Press only when needed. For example, after a tournament that happened just a little while ago. Frequent clicks may take a few seconds.
    </small>
  </div>
  <small id="lastUpdated">Last updated on: --</small>

  <h2>Tournaments</h2>
  <div id="tournamentContainer" class="tournament-list">
    <p class="loading">Loading tournaments...</p>
  </div>
</main>

<script>
const TEAM_ID = "waf-fled"; // Your Lichess team
let cachedTournaments = JSON.parse(localStorage.getItem("wafTournaments")) || { tournaments: [], lastUpdated: null };

async function fetchTeamTournaments(){
  try {
    const res = await fetch(`https://lichess.org/api/team/${TEAM_ID}/tournament`);
    const data = await res.json();
    return data; // array of tournaments
  } catch {
    return [];
  }
}

function renderTournaments(tournaments){
  const container = document.getElementById("tournamentContainer");
  if(!tournaments.length){
    container.innerHTML="<p class='loading'>No tournaments found</p>";
    return;
  }

  container.innerHTML = tournaments.map(t=>{
    const endTime = new Date(t.endsAt);
    const isPast = endTime < new Date();
    const statusClass = isPast?"status-past":"status-future";
    const statusText = isPast?"Finished":"Upcoming";

    return `
      <div class="tournament-box">
        <a href="${t.url}" target="_blank">${t.name}</a>
        <span class="tournament-status ${statusClass}">${statusText}</span>
        <span>Ends: ${endTime.toLocaleString()}</span>
      </div>
    `;
  }).join("");
}

async function buildTournaments(){
  document.getElementById("tournamentContainer").innerHTML = '<p class="loading">Loading tournaments...</p>';
  const tournaments = await fetchTeamTournaments();
  cachedTournaments.tournaments = tournaments;
  cachedTournaments.lastUpdated = Date.now();
  localStorage.setItem("wafTournaments",JSON.stringify(cachedTournaments));

  renderTournaments(tournaments);
  document.getElementById("lastUpdated").innerText="Last updated on: "+new Date(cachedTournaments.lastUpdated).toLocaleString();
}

// Use cached data if available
if(cachedTournaments.tournaments.length){
  renderTournaments(cachedTournaments.tournaments);
  if(cachedTournaments.lastUpdated)
    document.getElementById("lastUpdated").innerText="Last updated on: "+new Date(cachedTournaments.lastUpdated).toLocaleString();
}

document.getElementById("updateBtn").addEventListener("click",buildTournaments);
</script>
</body>
</html>
