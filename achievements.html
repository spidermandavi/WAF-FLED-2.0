<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>WAF-FLED! Achievements</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="style.css">

<style>
.loading {
  display:flex;
  justify-content:center;
  align-items:center;
  gap:10px;
  padding:1rem;
  font-style:italic;
  opacity:0.8;
}
.spinner {
  width:16px;
  height:16px;
  border:3px solid #444;
  border-top:3px solid #ffd54a;
  border-radius:50%;
  animation:spin 0.8s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }

.podium-slot.place-1 { background: gold; }
.podium-slot.place-2 { background: silver; }
.podium-slot.place-3 { background: #cd7f32; }

#lastUpdated { display:block; margin-bottom:0.5rem; font-size:0.85rem; color:#aaa; }

.export-wrap { text-align:center; margin-bottom:1rem; }
.export-wrap button {
  background:#ffd54a; color:#000; border:none;
  padding:0.5rem 1rem; font-weight:bold;
  border-radius:6px; cursor:pointer;
}
.export-wrap button:hover { opacity:0.85; }

@keyframes flashStat {
  0% { transform: scale(1); opacity:0.3; }
  30% { transform: scale(1.5); opacity:1; }
  60% { transform: scale(1.2); opacity:0.8; }
  100% { transform: scale(1); opacity:1; }
}
.stat-flash { display:inline-block; animation:flashStat 0.8s ease; }
</style>
</head>

<body>
<header>
<h1>ğŸ§‡ WAF-FLED!</h1>
<nav>
<a href="index.html">Leaderboard</a>
<a href="results.html">Tournaments</a>
<a href="achievements.html">Achievements</a>
</nav>
</header>

<main>
<small id="lastUpdated">Last updated: --</small>

<div class="export-wrap">
  <button onclick="exportAchievementsHTML()">ğŸ“‹ Export Achievements (HTML)</button>
</div>

<h2>ğŸ† Achievements</h2>

<section>
<h2>ğŸ§‡ Most WAFFLES</h2>
<div class="podium" id="podium-waffles"><p class="loading"><div class="spinner"></div>Loading...</p></div>
</section>

<section>
<h2>ğŸ’¥ Most WAFFLED</h2>
<div class="podium" id="podium-waffled"><p class="loading"><div class="spinner"></div>Loading...</p></div>
</section>

<section>
<h2>ğŸ“ˆ Most Committed</h2>
<div class="podium" id="podium-committed"><p class="loading"><div class="spinner"></div>Loading...</p></div>
</section>
</main>

<script>
// ======= CONFIG =======
const MANUAL_TOURNAMENTS = ["ZLfbxNcu","Z2DuzTxs","O4X6VErR","HVMkt9VQ","NmRTO3Nr","wIUsm1em"];

// ======= PGN PARSER =======
function parsePGN(pgn){
  const white = pgn.match(/\[White "(.+?)"]/)[1];
  const black = pgn.match(/\[Black "(.+?)"]/)[1];
  const termination = pgn.match(/\[Termination "(.+?)"]/)?.[1]||"";

  let whiteRes="draw", blackRes="draw";
  if(pgn.includes("1-0")){ whiteRes="win"; blackRes="loss"; }
  else if(pgn.includes("0-1")){ whiteRes="loss"; blackRes="win"; }

  if(termination.includes("Time forfeit")){
    if(whiteRes==="win") whiteRes="flag_win";
    if(blackRes==="win") blackRes="flag_win";
    if(whiteRes==="loss") whiteRes="flag_loss";
    if(blackRes==="loss") blackRes="flag_loss";
  }

  return [{name:white,res:whiteRes},{name:black,res:blackRes}];
}

// ======= FETCH GAMES =======
async function fetchGames(id){
  try {
    const r = await fetch(`https://lichess.org/api/tournament/${id}/games`);
    const txt = await r.text();
    if(!txt.trim()) return [];
    return txt.split(/\n(?=\[Event)/).flatMap(parsePGN);
  } catch { return []; }
}

// ======= STATE FOR EXPORT =======
let PODIUM_STATE = { waffles:[], waffled:[], committed:[] };

// ======= BUILD PODIUM =======
function buildPodium(id,data,key,isGames=false){
  const medals=["ğŸ¥‡","ğŸ¥ˆ","ğŸ¥‰"];
  const container=document.getElementById(id);
  const top3=[...data].sort((a,b)=>b[key]-a[key]).slice(0,3);
  if(!top3.length){ container.innerHTML="<p class='loading'>No data yet</p>"; return; }

  PODIUM_STATE[id.includes("waffles")?"waffles":id.includes("waffled")?"waffled":"committed"]=top3;

  container.innerHTML = top3.map((p,i)=>`
    <div class="podium-slot place-${i+1}">
      <div class="trophy">${medals[i]}</div>
      <div class="name">${p.name}</div>
      <div class="value stat-flash">${p[key]}${isGames?" games":""}</div>
    </div>`).join("");
}

// ======= BUILD ACHIEVEMENTS (progressive + top spinner) =======
async function buildAchievements(){
  const players={};
  document.querySelectorAll(".podium").forEach(p=>p.innerHTML="<p class='loading'><div class='spinner'></div>Loading...</p>");

  for(const [index,t] of MANUAL_TOURNAMENTS.entries()){
    const games = await fetchGames(t);
    games.forEach(g=>{
      if(!players[g.name]) players[g.name]={name:g.name,waffles:0,waffled:0,games:0};
      if(g.res==="flag_win") players[g.name].waffles++;
      if(g.res==="flag_loss") players[g.name].waffled++;
      players[g.name].games++;
    });

    // progressive render with spinner at top if not last tournament
    const list = Object.values(players);
    buildPodium("podium-waffles", list, "waffles");
    buildPodium("podium-waffled", list, "waffled");
    buildPodium("podium-committed", list, "games", true);

    if(index < MANUAL_TOURNAMENTS.length - 1){
      document.querySelectorAll(".podium").forEach(p=>{
        p.innerHTML = `<p class='loading'><div class='spinner'></div>Loading more tournaments...</p>` + p.innerHTML;
      });
    }
  }

  document.getElementById("lastUpdated").innerText="Last updated: "+new Date().toLocaleString();
}

// ======= EXPORT ACHIEVEMENTS =======
function exportAchievementsHTML(){
  const medals=["ğŸ¥‡","ğŸ¥ˆ","ğŸ¥‰"];
  function section(title,list,valueLabel){
    return `<section>
<h2>${title}</h2>
<div class="podium">
${list.map((p,i)=>`
  <div class="podium-slot place-${i+1}">
    <div class="trophy">${medals[i]}</div>
    <div class="name">${p.name}</div>
    <div class="value">${p[valueLabel]}</div>
  </div>`).join("")}
</div></section>`;
  }

  const html =
`<!-- START AUTO-GENERATED WAF-FLED ACHIEVEMENTS -->
<h2>ğŸ† Achievements</h2>
<p class="updated">Generated: ${new Date().toLocaleString()}</p>

${section("ğŸ§‡ Most WAFFLES", PODIUM_STATE.waffles,"waffles")}
${section("ğŸ’¥ Most WAFFLED", PODIUM_STATE.waffled,"waffled")}
${section("ğŸ“ˆ Most Committed", PODIUM_STATE.committed,"games")}
<!-- END AUTO-GENERATED WAF-FLED ACHIEVEMENTS -->`;

  navigator.clipboard.writeText(html);
  alert("Achievements HTML copied to clipboard");
}

buildAchievements();
</script>
</body>
</html>
