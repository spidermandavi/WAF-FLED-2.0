<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>WAF-FLED! Achievements</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="style.css">

<style>
.loading {
  text-align: center;
  opacity: 0.8;
  font-style: italic;
  margin-top: 1rem;
}

.podium-slot.place-1 { background: gold; }
.podium-slot.place-2 { background: silver; }
.podium-slot.place-3 { background: #cd7f32; }

#lastUpdated {
  display: block;
  margin-bottom: 0.5rem;
  font-size: 0.85rem;
  color: #aaa;
}

.update-section {
  text-align: center;
  margin-bottom: 1rem;
}
.update-btn {
  padding: 0.4rem 0.8rem;
  border-radius: 6px;
  border: none;
  cursor: pointer;
  background: #ffd54a;
  font-weight: bold;
}

@keyframes flashStat {
  0% { transform: scale(1); opacity: 0.3; }
  30% { transform: scale(1.5); opacity: 1; }
  60% { transform: scale(1.2); opacity: 0.8; }
  100% { transform: scale(1); opacity: 1; }
}
.stat-flash {
  display: inline-block;
  animation: flashStat 0.8s ease;
}
</style>
</head>

<body>
<header>
<h1>üßá WAF-FLED!</h1>
<nav>
<a href="index.html">Leaderboard</a>
<a href="results.html">Tournaments</a>
<a href="achievements.html">Achievements</a>
</nav>
</header>

<main>
<div class="update-section">
  <button class="update-btn" id="updateBtn">üîÑ Check for updates</button>
</div>

<small id="lastUpdated">Last updated on: --</small>

<h2>üèÜ Achievements</h2>

<section>
<h2>üßá Most WAFFLES</h2>
<div class="podium" id="podium-waffles"><p class="loading">Loading...</p></div>
</section>

<section>
<h2>üí• Most WAFFLED</h2>
<div class="podium" id="podium-waffled"><p class="loading">Loading...</p></div>
</section>

<section>
<h2>üìà Most Committed</h2>
<div class="podium" id="podium-committed"><p class="loading">Loading...</p></div>
</section>
</main>

<script>
// ================= CONFIG =================
const TEAM_SLUG = "world-antichess-front";
const NAME_REGEX = /^Weekly WAF-FLED \d+ Arena$/;
const STORAGE_KEY = "wafAchievementsCache";

// ================= FETCH TEAM TOURNAMENTS =================
async function fetchTeamTournaments(){
  try {
    const res = await fetch(`https://lichess.org/api/team/${TEAM_SLUG}/tournaments`);
    const text = await res.text();

    return text
      .trim()
      .split("\n")
      .map(l => JSON.parse(l))
      .filter(t => NAME_REGEX.test(t.name))
      .map(t => t.id);
  } catch {
    return [];
  }
}

// ================= PGN PARSER =================
function parsePGN(pgn){
  const white = pgn.match(/\[White "(.+?)"]/)[1];
  const black = pgn.match(/\[Black "(.+?)"]/)[1];
  const termination = pgn.match(/\[Termination "(.+?)"]/)?.[1] || "";

  let whiteRes="draw", blackRes="draw";
  if(pgn.includes("1-0")){ whiteRes="win"; blackRes="loss"; }
  else if(pgn.includes("0-1")){ whiteRes="loss"; blackRes="win"; }

  if(termination.includes("Time forfeit")){
    if(whiteRes==="win") whiteRes="flag_win";
    if(blackRes==="win") blackRes="flag_win";
    if(whiteRes==="loss") whiteRes="flag_loss";
    if(blackRes==="loss") blackRes="flag_loss";
  }

  return [
    { name:white, res:whiteRes },
    { name:black, res:blackRes }
  ];
}

// ================= FETCH GAMES =================
async function fetchGames(id){
  try {
    const r = await fetch(`https://lichess.org/api/tournament/${id}/games`);
    const txt = await r.text();
    if(!txt.trim()) return [];
    return txt.split(/\n(?=\[Event)/).flatMap(parsePGN);
  } catch {
    return [];
  }
}

// ================= PODIUM =================
function buildPodium(id,data,key,isGames=false){
  const medals=["ü•á","ü•à","ü•â"];
  const container=document.getElementById(id);

  const top3=[...data].sort((a,b)=>b[key]-a[key]).slice(0,3);

  if(!top3.length){
    container.innerHTML="<p class='loading'>No data yet</p>";
    return;
  }

  container.innerHTML=top3.map((p,i)=>`
    <div class="podium-slot place-${i+1}">
      <div class="trophy">${medals[i]}</div>
      <div class="name">${p.name}</div>
      <div class="value stat-flash">
        ${p[key]}${isGames?" games":""}
      </div>
    </div>
  `).join("");
}

// ================= RENDER FROM DATA =================
function renderAchievements(players){
  const list = Object.values(players);
  buildPodium("podium-waffles", list, "waffles");
  buildPodium("podium-waffled", list, "waffled");
  buildPodium("podium-committed", list, "games", true);
}

// ================= BUILD ACHIEVEMENTS =================
async function buildAchievements(){
  document.querySelectorAll(".podium").forEach(p=>{
    p.innerHTML="<p class='loading'>Loading...</p>";
  });

  const players = {};
  const tmtIds = await fetchTeamTournaments();
  const gamesArrays = await Promise.all(tmtIds.map(fetchGames));
  const allGames = gamesArrays.flat();

  allGames.forEach(g=>{
    if(!players[g.name]) players[g.name]={name:g.name, waffles:0, waffled:0, games:0};
    if(g.res==="flag_win") players[g.name].waffles++;
    if(g.res==="flag_loss") players[g.name].waffled++;
    players[g.name].games++;
  });

  const cache = {
    players,
    lastUpdated: Date.now()
  };
  localStorage.setItem(STORAGE_KEY, JSON.stringify(cache));

  renderAchievements(players);
  document.getElementById("lastUpdated").innerText =
    "Last updated on: " + new Date(cache.lastUpdated).toLocaleString();
}

// ================= CACHE LOAD =================
const cached = JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}");
if(cached.players){
  renderAchievements(cached.players);
  if(cached.lastUpdated){
    document.getElementById("lastUpdated").innerText =
      "Last updated on: " + new Date(cached.lastUpdated).toLocaleString();
  }
}

// BUTTON
document.getElementById("updateBtn").addEventListener("click", buildAchievements);

// AUTO LOAD (only rebuilds if no cache)
if(!cached.players){
  buildAchievements();
}
</script>
</body>
</html>
